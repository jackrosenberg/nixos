{ pkgs, config, ... }:
{
  # secret management via yubikey
  # https://github.com/oddlama/agenix-rekey

  # generate keyspairs with: 
  # age-keygen -pq

  environment.systemPackages = with pkgs; [ age ];
  
  age.rekey = {
    storageMode = "local";
    masterIdentities = [ 
      "/etc/nixos/secrets/yubikey.pub"
      # {
      #   identity = "/etc/nixos/secrets/identity.age";
      #   pubkey = "age1pq1cjqm3etujptmrdl4sel03xj76gfugdxxzhv95wmlrsxm656gxfy40hejjczdpwu9ayrjysr56pp37hvgya6kqhndtvd85qjsyntzthap4urdrvacgw20z6yzkytqpmcn9wk7kjxsps4s6sf9pv9qau73gpgpftmv3dgfaueuk624x3k4ds2wzga2zxmumsf47wzge82j2zumpshdxjluwu60c2vmafwcq9w2hf7anpcvuszl55ggtuv80wma498mkcnt9crpdwy3hy45zys5jn0sttr64v4t6624e7jt8sws93jxtwexwurex0nvfqun0lhhx28jqmp59sjvxnwzts6vrnrcvy82v53cpj9qumym0ylyfmg6j2rsckrfh3rak73500h4klqdny3tgy47jyvzdgsgjheycehag5pt7jcx65u6dac6tltfj2ucc376vem3czwzl8d8jnh5jpfhwuk3xyucpk4lq4e2j3wcyxeyqx29vsn3x0ya2wc3j2rxpuxefxee9q3amdqn24q63w98f72f3pqzcgt5h5jqe6qep7x6hz4zqzmr7pz40559umtgzsgr8ershsjew9r6hxxdyhr4fet6xlnhnw75w3q9sq54u5v9kzpcvyn04se48vgtv6rk3yp9c7ny9vdnxezrzzcghwpcxdqz9dnc8rh63fl0m9rpectsnsc4rf0hnykeky8a2sesf2ge47469stphcvx33ggcggknuna64qz3ndqknh5qntvzgall3ydq6vftnxgxcwttxayeqft8fzt3d4ej7cf8twdkgqe4delqzednzjt0xeyv4qxcgm7uw64jg70p0tka3vuqflq3qeplrx99k5lwrcyx2g4g7rwvcc94djc7xqhw5z6c4zzc7mnd0j7cqmtn25dy4mh3m53zdftgvchu96rdp92tcjnhyuzd0mmr9f02sq433ktjtpxwn0zgpzkzwej2krxdznjm6wqchvhjskryxmz6jv3av3yxgyyqehqnuptce0m2k02y3kylxykh6v225n9c474ckwaw2rncjpfg0ucz3d4rv9xgxwgr3n0pvuurxrvn5fckjj2j4nrnet5d8gujhquzcgfsg3av3a5n3xrseuf6wf8werj4d5mu6m64p7y2zf5m88jnu4hw8nsepy8x9zmdae2pcvmyy0xq54cfy0cnu2js9y4u56e2t5l2gd2275guyfh9kgu6h68pvrs20p6xx590wuu6my26n6j4erl2srwgejxtd2h3ee59z4tq7z78dmml2rpmj9afuc47n29yx6d0vc43pufuyf5ddepvjkh94s2pwyrm09h3cu47nnvvpkuz6r5c52fdxvckevr0hgh72j6h083dt0savlwuugldkcq9uesn0sfwfn9t996y5tgkueudfl8gryvvyl8xqypkjqs8aselftg2dhnk9u2dsud2j4pgqwv3luqqgh2wl208s2xg4j4vhmkc6cf2r9tqs52j5qxkk9jrqnj20zzq98m3t06u7e4zqyujyru3sku9sneq49ydvj3lc5q7hw2cfwxdppqcwm55j5hspsv4f4jg95jz4fkyy2n0sef2ffvnmptsqk83jgrjhx3msfc7arlsh54wuv3jmj2yulmxjnjk8r4q6mesyn5z84ve2s8su0rujganj5ny02mq76acrcgw95jmhzljy3mgykpkhg9nqws7675v4pk0qyjvluj5974ymxp4zxq3u2e7mmek0gr3t5mtw7sv08797zfu3qt942ykku7v2k68sujdmzu9akrzgngycerpsjm42jqvfg6uqkr9eggnlvh89sjdj2p4gu776vmt2pp2p0f3r370ptnhlx256678ayrkaja8tt33xw496ps2wjhtpygaz0wmpvszdkefqk5d760g00ssk62a220h2gd27kv9ca470rt";
      #
      # }
    ];
    # This cannot be shared with other hosts. Please refer to this path
    # from your flake's root directory and not by a direct path literal like ./secrets
    localStorageDir = ../secrets/rekeyed/${config.networking.hostName};
  };
}
